# Video Preview Scrubbing Implementation

## Overview

This implementation adds support for video preview scrubbing in the segment editor mobile app. Users can now see thumbnail previews when dragging the video player's seek bar.

## Features

### Preview Sources

Three preview source options are available in Settings > Playback:

1. **ðŸŒ Jellyfin Trickplay** (Default)
   - Fetches preview images from Jellyfin server's trickplay functionality
   - Most efficient as images are pre-generated by the server
   - Requires Jellyfin server to have trickplay enabled for the media

2. **ðŸ“± Local Generation**
   - Uses MediaMetadataRetriever to extract frames from the video
   - Works for local files and some network streams
   - More resource-intensive but doesn't require server-side trickplay

3. **ðŸš« Disabled**
   - No preview images shown during scrubbing
   - Lowest resource usage

## Architecture

### Core Components

#### 1. PreviewLoader Interface
```kotlin
interface PreviewLoader {
    suspend fun loadPreview(positionMs: Long): Bitmap?
    fun getPreviewInterval(): Long
    fun release()
}
```

#### 2. TrickplayPreviewLoader
- Implements Jellyfin's trickplay API
- **API Endpoints Used:**
  - `GET /Items/{itemId}` - Get item details with trickplay metadata embedded in `Trickplay` field
  - `GET /Videos/{itemId}/Trickplay/{width}/{index}.jpg` - Get tile sheet images

- **How it works:**
  1. Fetches item details from `/Items/{itemId}` endpoint
  2. Parses nested `Trickplay[mediaSourceId][width]` structure to get TrickplayInfoDto
  3. Calculates which tile sheet contains the thumbnail for a given position
  4. Downloads the tile sheet (a grid of thumbnails)
  5. Extracts the specific thumbnail from the grid
  5. Caches results for performance

- **Trickplay API Response Format (from /Items/{itemId}):**
```json
{
  "Trickplay": {
    "{mediaSourceId}": {
      "320": {
        "Width": 320,
        "Height": 180,
        "TileWidth": 10,
        "TileHeight": 10,
        "ThumbnailCount": 500,
        "Interval": 10000,
        "Bandwidth": 12345
      }
    }
  }
}
```

Note: The Interval is in milliseconds (e.g., 10000 = 10 seconds between thumbnails).

#### 3. MediaMetadataPreviewLoader
- Uses Android's MediaMetadataRetriever
- Extracts frames at specific positions
- Scales frames to 320x180 for preview display
- Caches generated previews
- **Note:** Works best with local file URIs; network streams may have limitations

#### 4. ScrubPreviewOverlay (NEW)
- Composable that displays preview thumbnail and timestamp
- Shows as a rounded card overlay above the video player
- Features:
  - 160x90 preview image display
  - Formatted timestamp (HH:MM:SS or MM:SS)
  - Loading indicator while fetching preview
  - Graceful fallback when preview unavailable
- Only visible during active scrubbing

#### 5. VideoPlayerWithPreview (NEW)
- Enhanced VideoPlayer component with scrub preview support
- Hooks into ExoPlayer's TimeBar.OnScrubListener
- Tracks scrub position during timeline drag
- Shows ScrubPreviewOverlay at top center when scrubbing
- Fallback logging if TimeBar not found

### Settings Integration

- Added `PreviewSource` enum to AppPreferences
- Settings stored in SecurePreferences (encrypted)
- UI in SettingsScreen with radio group selection
- Preference persists across app sessions

### Player Integration

- PlayerViewModel creates appropriate PreviewLoader based on settings
- PreviewLoader passed to VideoPlayerWithPreview component
- PlayerScreen uses VideoPlayerWithPreview instead of basic VideoPlayer
- Automatic preview display on seek bar scrubbing

## Implementation Status

### Completed âœ…
- [x] PreviewLoader interface and implementations
- [x] Trickplay API integration with Jellyfin (using correct /Items endpoint)
- [x] Fixed interval calculation bug (was incorrectly multiplying by 1000)
- [x] MediaMetadataRetriever-based local preview generation
- [x] Settings screen integration
- [x] Preference storage
- [x] ScrubPreviewOverlay UI component
- [x] VideoPlayerWithPreview with TimeBar scrub listener
- [x] Player screen integration
- [x] String resources (English)
- [x] Code review and security checks
- [x] All code compiles successfully

### Pending â³
- [ ] Testing on actual devices with real Jellyfin server
- [ ] Localization for other languages (German, Spanish)
- [ ] Performance testing with large video files

## Usage

### For Users

1. Open Settings
2. Navigate to Playback section
3. Select "Video Scrub Previews" option
4. Choose preview source:
   - Jellyfin Trickplay (recommended if server has trickplay enabled)
   - Local Generation (for local files or if trickplay unavailable)
   - Disabled (to save resources)
5. Play a video and drag the seek bar to see preview thumbnails

### For Developers

#### Using VideoPlayerWithPreview:

```kotlin
val previewLoader = viewModel.createPreviewLoader(itemId, streamUrl)
VideoPlayerWithPreview(
    streamUrl = streamUrl,
    previewLoader = previewLoader,
    onPlayerReady = { exoPlayer -> 
        // Handle player ready
    },
    onPlaybackStateChanged = { isPlaying, currentPos, bufferedPos ->
        // Handle playback state changes
    }
)
```

#### Creating a custom preview loader:

```kotlin
class CustomPreviewLoader : PreviewLoader {
    override suspend fun loadPreview(positionMs: Long): Bitmap? {
        // Your implementation
    }
    
    override fun getPreviewInterval(): Long {
        return 10000L // 10 seconds between previews
    }
    
    override fun release() {
        // Clean up resources
    }
}
```

## How It Works

### Scrubbing Flow

1. User starts dragging the video seek bar
2. TimeBar.OnScrubListener detects `onScrubStart`
3. As user drags, `onScrubMove` updates scrub position
4. ScrubPreviewOverlay appears showing:
   - Loading state while fetching preview
   - Preview thumbnail at scrub position
   - Formatted timestamp
5. PreviewLoader asynchronously loads the frame:
   - TrickplayPreviewLoader: Fetches from server's tile sheets
   - MediaMetadataPreviewLoader: Extracts from video file
6. When user releases, `onScrubStop` hides the overlay

### Performance Optimizations

- Preview bitmaps are cached (20 entries max)
- Only loads preview when scrub position changes
- Async loading prevents UI blocking
- Old cache entries automatically evicted
- Graceful degradation when previews fail to load

## Future Enhancements

### Additional Features

- Preview quality settings (resolution selection from available widths)
- Preview interval customization
- Thumbnail generation progress indicator
- Automatic fallback mechanism (try trickplay, fallback to local if unavailable)
- Preview preloading for even smoother scrubbing experience
- Disk cache for trickplay tile sheets to reduce network requests
- Configurable cache sizes based on device memory

## Technical Notes

### Trickplay Interval Calculation

The interval returned by Jellyfin is in milliseconds. To calculate which thumbnail to show:

```kotlin
val thumbnailIndex = (positionMs / interval).toInt()  // No multiplication needed!
val tilesPerImage = tileWidth * tileHeight
val imageIndex = thumbnailIndex / tilesPerImage
val tileIndexInImage = thumbnailIndex % tilesPerImage
```

### Resource Management

- PreviewLoaders automatically release resources when PlayerScreen disposes
- Bitmap cache limited to 20 entries to prevent memory issues
- Old cache entries evicted when limit reached

### Network Requests

- Uses shared OkHttpClient from Hilt dependency injection
- Includes authentication headers from SecurePreferences
- 30-second timeouts for network requests

## Testing

### Manual Testing Checklist

- [ ] Settings screen displays preview source option
- [ ] Selection persists after app restart
- [ ] Trickplay loader fetches images from Jellyfin
- [ ] MediaMetadata loader generates frames from video
- [ ] Disabled option shows no previews
- [ ] No crashes when switching between sources
- [ ] Memory usage remains stable during scrubbing
- [ ] Preview images display correct frames

### Integration Testing

Since external preview UI is not yet implemented:

1. Verify PreviewLoader is created based on settings
2. Check logs for preview loading attempts
3. Verify no crashes occur during playback
4. Confirm resources are properly released

## Known Limitations

1. **PreviewSeekBar Library**: Not included due to build environment network restrictions. Commented out in build.gradle.

2. **MediaMetadataRetriever**: May not work with all network stream formats (especially HLS with authentication).

3. **No Visual Feedback**: Preview infrastructure is in place, but actual preview display requires custom UI implementation or PreviewSeekBar integration.

4. **Trickplay Availability**: Requires Jellyfin server to have trickplay pre-generated for media items.

## References

- [Jellyfin API Documentation](https://api.jellyfin.org/)
- [Jellyfin Trickplay Feature](https://jellyfin.org/docs/)
- [Android MediaMetadataRetriever](https://developer.android.com/reference/android/media/MediaMetadataRetriever)
- [ExoPlayer Documentation](https://developer.android.com/media/media3/exoplayer)
